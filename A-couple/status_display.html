<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캐릭터 상태창</title>
    <style>
        /* Google Fonts Import */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@900&display=swap');

        /* Base Styling */
        body {
            background-color: #333;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 1s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Main Column Layout */
        .two-dialog-col {
            --item-padding: 10px;
            --item-sprite-line: rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 900px;
            gap: var(--item-padding);
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.5));
        }

        .two-dialog-dialog {
            display: flex;
            flex-direction: column;
            gap: var(--item-padding);
            width: 100%;
        }

        .two-dialog-container {
            display: flex;
            gap: var(--item-padding);
            flex-wrap: nowrap;
            justify-content: center;
            width: 100%;
        }

        /* Character Card Styling */
        .two-dialog-card {
            width: calc(50% - (var(--item-padding) / 2));
            height: 480px;
            border-radius: 8px;
            background: repeating-linear-gradient(
                45deg,
                var(--item-sprite-line),
                var(--item-sprite-line) 2px,
                transparent 2px,
                transparent 6px
            );
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.5s ease-in-out, transform 0.3s ease;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer; /* 클릭 가능함을 표시 */
        }

        .two-dialog-char-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 20%;
            margin: 0;
            transition: filter 0.5s, transform 0.5s ease-in-out;
        }
        
        /* Card Hover Effect */
        .two-dialog-card:hover {
            width: 60%;
            transform: scale(1.02);
            z-index: 10;
        }

        .two-dialog-card:hover > .two-dialog-char-img {
            filter: blur(5px) brightness(0.7);
            transform: scale(1.1);
        }

        /* 이미지 업로드 힌트 */
        .upload-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 2;
        }

        .two-dialog-card:hover .upload-hint {
            opacity: 1;
        }

        /* Info Panel on Hover */
        .two-dialog-info {
            font-family: 'Gowun Batang', 'Roboto', sans-serif;
            position: absolute;
            z-index: 1;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 4px;
            padding: 15px;
            opacity: 0;
            transition: opacity 0.5s;
            max-height: 90%;
            overflow-y: auto;
            width: 90%;
            color: white;
            visibility: hidden;
        }

        .two-dialog-card:hover .two-dialog-info {
            opacity: 1;
            visibility: visible;
        }

        .two-dialog-info-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
            line-height: 1.5;
            display: flex;
            gap: 8px;
        }
        .two-dialog-info-box .label {
            font-weight: bold;
            color: #ddd;
            flex-shrink: 0;
        }
        .two-dialog-info-box .value {
            flex-grow: 1;
            color: #fff;
            outline: none;
            min-height: 1.2em;
        }
        .two-dialog-info-box .value:focus {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .two-dialog-info-box:last-child {
            margin-bottom: 0;
        }
        
        /* Mood/Inner Thought Box */
        .cc-info-box1 {
            background: #9D90B4;
            color: #3F3551;
            font-family: 'Noto Serif KR', serif;
            font-weight: 900;
        }
        .cc-info-box1 .label {
            color: #5a4b73;
        }
        .cc-info-box1 .value {
            color: #3F3551;
        }

        /* Time/Weather Display Card */
        .two-dialog-simple-card {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            overflow: hidden;
            position: relative;
            padding: 15px;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
        }

        .two-dialog-details {
            color: white;
            text-align: right;
            font-family: 'Gowun Batang', 'Roboto', sans-serif;
            z-index: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            text-shadow: 1px 1px 3px #000;
        }
        .date { font-size: 0.9em; }
        .time { font-weight: bold; font-size: 1.2em;}

        /* Weather Controller */
        .weather-control {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
        }
        .weather-control label {
            color: white;
            font-family: 'Gowun Batang', sans-serif;
        }
        .weather-control button {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .weather-control button:hover {
            background-color: rgba(255,255,255,0.4);
        }
        .weather-control button.active {
            background-color: #9D90B4;
            color: #3F3551;
            font-weight: bold;
            border-color: #9D90B4;
        }

        /* 음악 컨트롤 */
        .music-control {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
            width: 100%;
        }
        .music-control label {
            color: white;
            font-family: 'Gowun Batang', sans-serif;
        }
        .music-control input {
            flex: 1;
            min-width: 200px;
            padding: 5px 10px;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .music-control input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .music-control button {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .music-control button:hover {
            background-color: rgba(255,255,255,0.4);
        }

        /* 숨겨진 파일 입력 */
        .hidden-file-input {
            display: none;
        }

        /* YouTube 플레이어 컨테이너 */
        .youtube-container {
            position: fixed;
            top: -200px;
            left: -200px;
            width: 100px;
            height: 100px;
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>
<body>

    <div class="two-dialog-col">
        <!-- Weather Selection UI -->
        <div class="weather-control">
            <label>날씨 선택:</label>
            <button data-weather="Clear">맑음</button>
            <button data-weather="Cloudy">흐림</button>
            <button data-weather="Rainy">비</button>
            <button data-weather="Snowy">눈</button>
        </div>

        <!-- 음악 컨트롤 -->
        <div class="music-control">
            <label>배경음악:</label>
            <input type="text" id="music-url" placeholder="YouTube 링크를 입력하세요...">
            <button id="play-music">재생</button>
            <button id="stop-music">정지</button>
        </div>

        <div class="two-dialog-dialog">
            <div class="two-dialog-container">
                <!-- Torm's Card -->
                <div id="Toma-card" class="two-dialog-card" data-character="Toma">
                    <div class="upload-hint">클릭해서 이미지 변경</div>
                    <img src="https://blog.kakaocdn.net/dna/bMS9On/btsQfjnzx4B/AAAAAAAAAAAAAAAAAAAAAGloEax36-NIMuZAMpBgzEbdxEfeo0sDNSR9NR2iS9e7/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1756652399&allow_ip=&allow_referer=&signature=upx9leFKDbUBAFv5IQ%2BONLRVoS4%3D" alt="Toma" class="two-dialog-char-img" id="Toma-img"/>
                    <div class="two-dialog-info">
                        <h3 style="text-align: center; margin-top: 0;">TOMA</h3>
                        <div class="two-dialog-info-box">
                            <span class="label">위치:</span>
                            <div class="value" id="Toma-location" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">소지품:</span>
                            <div class="value" id="Toma-outfit" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">내심:</span>
                            <div class="value" id="Toma-relations" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">상태:</span>
                            <div class="value" id="Toma-status" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box cc-info-box1">
                            <span class="label">한마디:</span>
                            <div class="value" id="Toma-thoughts" contenteditable="true"></div>
                        </div>
                    </div>
                </div>
                <!-- Turles's Card -->
                <div id="Turles-card" class="two-dialog-card" data-character="Turles">
                    <div class="upload-hint">클릭해서 이미지 변경</div>
                    <img src="https://blog.kakaocdn.net/dna/bKu25Q/btsQb5EAB6M/AAAAAAAAAAAAAAAAAAAAANYNIyVG4rc7JTmmSVIW36iwP15HeLNwP_vjDGrdunOZ/img.jpg?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1756652399&allow_ip=&allow_referer=&signature=Jpk0%2FguItPmYKHMMbkLyljXvFRM%3D" alt="Turles" class="two-dialog-char-img" id="Turles-img"/>
                    <div class="two-dialog-info">
                        <h3 style="text-align: center; margin-top: 0;">TURLES</h3>
                        <div class="two-dialog-info-box">
                            <span class="label">위치:</span>
                            <div class="value" id="Turles-location" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">소지품:</span>
                            <div class="value" id="Turles-outfit" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                           <span class="label">내심:</span>
                            <div class="value" id="Turles-relations" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">상태:</span>
                            <div class="value" id="Turles-status" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box cc-info-box1">
                            <span class="label">한마디:</span>
                            <div class="value" id="Turles-thoughts" contenteditable="true"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Time and Weather Display -->
            <div class="two-dialog-simple-card">
                <div class="two-dialog-details">
                    <div class="date" id="date-display"></div>
                    <div class="time" id="time-display"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 숨겨진 파일 입력들 -->
    <input type="file" id="Toma-file-input" class="hidden-file-input" accept="image/*">
    <input type="file" id="Turles-file-input" class="hidden-file-input" accept="image/*">

    <!-- YouTube 플레이어 -->
    <div id="youtube-container" class="youtube-container"></div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// Firebase 초기화
const firebaseConfig = {
    apiKey: "AIzaSyCJJ1lrIM5FEEATY3oZ7CMr39FJcABfjVE",
    authDomain: "toma92-598c0.firebaseapp.com",
    databaseURL: "https://toma92-598c0-default-rtdb.firebaseio.com/",
    projectId: "toma92-598c0",
    storageBucket: "toma92-598c0.firebasestorage.app",
    messagingSenderId: "648817460899",
    appId: "1:648817460899:web:470ddda64fadea79b8a116"
};

// Firebase 초기화를 안전하게 처리
function initializeFirebase() {
    try {
        if (typeof firebase === 'undefined') {
            console.log('Firebase 로딩 중... 재시도합니다.');
            setTimeout(initializeFirebase, 100);
            return;
        }
        firebase.initializeApp(firebaseConfig);
        console.log('Firebase 초기화 완료');
        startApp();
    } catch (error) {
        console.error('Firebase 초기화 오류:', error);
        setTimeout(initializeFirebase, 500);
    }
}

function startApp() {
    const database = firebase.database();
    // --- ELEMENTS ---
    const editableFields = document.querySelectorAll('.value[contenteditable="true"]');
    const weatherButtons = document.querySelectorAll('.weather-control button');
    const dateDisplay = document.getElementById('date-display');
    const timeDisplay = document.getElementById('time-display');
    const musicUrlInput = document.getElementById('music-url');
    const playMusicBtn = document.getElementById('play-music');
    const stopMusicBtn = document.getElementById('stop-music');
    
    // 캐릭터 카드와 파일 입력들
    const tomaCard = document.getElementById('Toma-card');
    const turlesCard = document.getElementById('Turles-card');
    const tomaFileInput = document.getElementById('Toma-file-input');
    const turlesFileInput = document.getElementById('Turles-file-input');
    const tomaImg = document.getElementById('Toma-img');
    const turlesImg = document.getElementById('Turles-img');

    // --- DATA ---
    const backgroundAssets = {
        Clear_morning: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Clear-morning.jpg',
        Clear_afternoon: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Clear-afternoon.jpg',
        Clear_evening: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Clear-evening.jpg',
        Clear_night: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Clear-night.jpg',
        Cloudy_morning: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Cloudy-morning.jpg',
        Cloudy_afternoon: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Cloudy-afternoon.jpg',
        Cloudy_evening: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Cloudy-evening.jpg',
        Cloudy_night: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Cloudy-night.jpg',
        // 비 이미지들 (여러 장)
        Rainy_day_01: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Rainy-day.jpg',
        Rainy_day_02: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Rainy_afternoon.png',
        Rainy_day_03: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Rainy_evening.png',
        // 눈 이미지들 (여러 장)
        Snowy_day_01: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Snowy-day.jpg',
        Snowy_day_02: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Snowy_night.png',
        Snowy_day_03: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Snowy_morning.png',
        // 기존 단일 이미지 (호환성을 위해 유지)
        Rainy_day: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Rainy_night.png',
        Snowy_day: 'https://raw.githubusercontent.com/tomato92-OM/T/refs/heads/main/images/Snowy_evening.png',
    };

    let currentConfig = {
        weather: 'Clear',
        rainyIndex: 1,  // 비 이미지 인덱스 (1, 2, 3 순환)
        snowyIndex: 1   // 눈 이미지 인덱스 (1, 2, 3 순환)
    };

    // YouTube 플레이어 관련 변수들
    let ytPlayer = null;
    let isYouTubeAPIReady = false;

    // --- FIREBASE FUNCTIONS ---
    function syncDataFromFirebase() {
        database.ref('statusData').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // 캐릭터 정보 업데이트
                editableFields.forEach(field => {
                    if (data.characters && data.characters[field.id]) {
                        if (document.activeElement !== field) {
                           field.textContent = data.characters[field.id];  
                        }
                    }
                });

                // 날씨 정보 업데이트
                if (data.weather) {
                    currentConfig.weather = data.weather;
                }
                if (data.rainyIndex) {
                    currentConfig.rainyIndex = data.rainyIndex;
                }
                if (data.snowyIndex) {
                    currentConfig.snowyIndex = data.snowyIndex;
                }
                updateWeatherButtons();
                updateTimeAndBackground();

                // 캐릭터 이미지 업데이트
                if (data.characterImages) {
                    if (data.characterImages.Toma && tomaImg.src !== data.characterImages.Toma) {
                        tomaImg.src = data.characterImages.Toma;
                    }
                    if (data.characterImages.Turles && turlesImg.src !== data.characterImages.Turles) {
    turlesImg.src = data.characterImages.Turles;
                    }
                }

                // 음악 URL 업데이트
                if (data.musicUrl && musicUrlInput.value !== data.musicUrl) {
                    musicUrlInput.value = data.musicUrl;
                }
            }
        });
    }

    function saveDataToFirebase(id, value) {
        database.ref(`statusData/characters/${id}`).set(value);
    }
    
    function saveWeatherToFirebase(weatherValue) {
        database.ref('statusData/weather').set(weatherValue);
    }

    function saveWeatherIndexToFirebase(weather, index) {
        if (weather === 'Rainy') {
            database.ref('statusData/rainyIndex').set(index);
        } else if (weather === 'Snowy') {
            database.ref('statusData/snowyIndex').set(index);
        }
    }

    function saveCharacterImageToFirebase(character, imageData) {
        database.ref(`statusData/characterImages/${character}`).set(imageData);
    }

    function saveMusicUrlToFirebase(url) {
        database.ref('statusData/musicUrl').set(url);
    }

    // --- IMAGE UPLOAD FUNCTIONS ---
    function handleImageUpload(file, character) {
        if (!file || !file.type.startsWith('image/')) {
            alert('이미지 파일만 업로드 가능합니다.');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const imageData = e.target.result;
            saveCharacterImageToFirebase(character, imageData);
        };
        reader.readAsDataURL(file);
    }

    // --- WEATHER FUNCTIONS ---
    function updateWeatherButtons() {
        weatherButtons.forEach(button => {
            button.classList.toggle('active', button.dataset.weather === currentConfig.weather);
        });
    }

    function handleWeatherChange(event) {
        const newWeather = event.target.dataset.weather;
        
        if (newWeather === currentConfig.weather) {
            // 같은 날씨 버튼을 다시 클릭한 경우
            if (newWeather === 'Rainy') {
                // 비 이미지 순환 (1 -> 2 -> 3 -> 1)
                currentConfig.rainyIndex = (currentConfig.rainyIndex % 3) + 1;
                saveWeatherIndexToFirebase('Rainy', currentConfig.rainyIndex);
            } else if (newWeather === 'Snowy') {
                // 눈 이미지 순환 (1 -> 2 -> 3 -> 1)
                currentConfig.snowyIndex = (currentConfig.snowyIndex % 3) + 1;
                saveWeatherIndexToFirebase('Snowy', currentConfig.snowyIndex);
            }
        } else {
            // 다른 날씨로 변경
            currentConfig.weather = newWeather;
            saveWeatherToFirebase(newWeather);
        }
        
        updateTimeAndBackground();
    }

    // --- YOUTUBE FUNCTIONS ---
    function loadYouTubeAPI() {
        if (window.YT) {
            isYouTubeAPIReady = true;
            return;
        }
        
        const tag = document.createElement('script');
        tag.src = 'https://www.youtube.com/iframe_api';
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }

    window.onYouTubeIframeAPIReady = function() {
        isYouTubeAPIReady = true;
    };

    function extractVideoId(url) {
        const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regex);
        return match ? match[1] : null;
    }

    function playYouTubeMusic(videoId) {
        if (!isYouTubeAPIReady) {
            alert('YouTube API가 아직 로드되지 않았습니다. 잠시 후 다시 시도해주세요.');
            return;
        }

        if (ytPlayer) {
            ytPlayer.destroy();
        }

        ytPlayer = new YT.Player('youtube-container', {
            height: '1',
            width: '1',
            videoId: videoId,
            playerVars: {
                'autoplay': 1,
                'loop': 1,
                'playlist': videoId,
                'controls': 0,
                'showinfo': 0,
                'rel': 0,
                'iv_load_policy': 3,
                'modestbranding': 1
            },
            events: {
                'onReady': function(event) {
                    event.target.setVolume(50);
                },
                'onError': function(event) {
                    alert('YouTube 비디오를 로드할 수 없습니다. URL을 확인해주세요.');
                }
            }
        });
    }

    function stopYouTubeMusic() {
        if (ytPlayer) {
            ytPlayer.destroy();
            ytPlayer = null;
        }
    }

    // --- TIME FUNCTIONS ---
    let timeOffset = 0;
    async function syncTime() {
        try {
            const response = await fetch('https://timeapi.io/api/Time/current/zone?timeZone=Asia/Seoul');
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            const serverTime = new Date(data.dateTime).getTime();
            const localTime = new Date().getTime();
            timeOffset = serverTime - localTime;
        } catch (error) {
            console.error('온라인 시간 동기화 실패', error);
        }
    }

    function updateTimeAndBackground() {
        const correctedNow = new Date(new Date().getTime() + timeOffset);
        const optionsDate = { timeZone: 'Asia/Seoul', year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const optionsTime = { timeZone: 'Asia/Seoul', hour: '2-digit', minute: '2-digit', hour12: true };
        dateDisplay.textContent = new Intl.DateTimeFormat('ko-KR', optionsDate).format(correctedNow);
        timeDisplay.textContent = new Intl.DateTimeFormat('en-US', optionsTime).format(correctedNow);

        const kstHour = new Date(correctedNow.toLocaleString('en-US', { timeZone: 'Asia/Seoul' })).getHours();
        let timeOfDay;
        if (kstHour >= 6 && kstHour < 12) timeOfDay = 'morning';
        else if (kstHour >= 12 && kstHour < 18) timeOfDay = 'afternoon';
        else if (kstHour >= 18 && kstHour < 22) timeOfDay = 'evening';
        else timeOfDay = 'night';

        let bgKey;
        if (currentConfig.weather === 'Rainy') {
            bgKey = `Rainy_day_${String(currentConfig.rainyIndex).padStart(2, '0')}`;
        } else if (currentConfig.weather === 'Snowy') {
            bgKey = `Snowy_day_${String(currentConfig.snowyIndex).padStart(2, '0')}`;
        } else {
            bgKey = `${currentConfig.weather}_${timeOfDay}`;
        }
        
        const newBgAsset = backgroundAssets[bgKey] || backgroundAssets['Clear_morning'];
        const newBgUrl = `url('${newBgAsset}')`;
        if (document.body.style.backgroundImage !== newBgUrl) {
            document.body.style.backgroundImage = newBgUrl;
        }
    }
    
    // --- EVENT LISTENERS ---
    editableFields.forEach(field => {
        field.addEventListener('input', (event) => {
            saveDataToFirebase(event.target.id, event.target.textContent);
        });
    });

    weatherButtons.forEach(button => {
        button.addEventListener('click', handleWeatherChange);
    });

    // 캐릭터 카드 클릭 이벤트
    tomaCard.addEventListener('click', (e) => {
        // info 패널 클릭은 무시
        if (e.target.closest('.two-dialog-info')) return;
        tomaFileInput.click();
    });

    turlesCard.addEventListener('click', (e) => {
        // info 패널 클릭은 무시
        if (e.target.closest('.two-dialog-info')) return;
        turlesFileInput.click();
    });

    // 파일 업로드 이벤트
    tomaFileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            handleImageUpload(e.target.files[0], 'Toma');
        }
    });

    turlesFileInput.addEventListener('change', (e) => {
        if (e.target.files[0]) {
            handleImageUpload(e.target.files[0], 'Turles');
        }
    });

    // 음악 컨트롤 이벤트
    playMusicBtn.addEventListener('click', () => {
        const url = musicUrlInput.value.trim();
        if (!url) {
            alert('YouTube 링크를 입력해주세요.');
            return;
        }

        const videoId = extractVideoId(url);
        if (!videoId) {
            alert('올바른 YouTube 링크를 입력해주세요.');
            return;
        }

        saveMusicUrlToFirebase(url);
        playYouTubeMusic(videoId);
    });

    stopMusicBtn.addEventListener('click', () => {
        stopYouTubeMusic();
    });

    musicUrlInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            playMusicBtn.click();
        }
    });

// --- INITIALIZATION ---
loadYouTubeAPI();
syncDataFromFirebase();

// 자동재생 기능 추가
setTimeout(() => {
    const savedUrl = musicUrlInput.value;
    if (savedUrl) {
        const videoId = extractVideoId(savedUrl);
        if (videoId && isYouTubeAPIReady) {
            playYouTubeMusic(videoId);
        }
    }
}, 2000); // 2초 후 자동재생

syncTime().then(() => {
    updateTimeAndBackground(); 
    setInterval(updateTimeAndBackground, 1000); 
});
setInterval(syncTime, 600000);
}

// 메모리 누수 방지 - 페이지 종료시 리스너 정리
window.addEventListener('beforeunload', () => {
    if (database) {
        database.ref('statusData').off();
    }
    if (ytPlayer) {
        ytPlayer.destroy();
    }
});

// DOM이 로드된 후 Firebase 초기화 시작
document.addEventListener('DOMContentLoaded', () => {
    initializeFirebase();
});
</script>

</body>
</html>

