<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>캐릭터 상태창</title>
    <style>
        /* Google Fonts Import */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@900&display=swap');

        /* Base Styling */
        body {
            /* 요청사항 02: 날씨 이미지를 전체 배경으로 설정합니다. */
            background-color: #333;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 1s ease-in-out; /* 배경이 부드럽게 전환되도록 효과 추가 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Main Column Layout */
        .two-dialog-col {
            --item-padding: 10px;
            --item-sprite-line: rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 900px; /* Increased max-width for better layout */
            gap: var(--item-padding);
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.5));
        }

        .two-dialog-dialog {
            display: flex;
            flex-direction: column;
            gap: var(--item-padding);
            width: 100%;
        }

        .two-dialog-container {
            display: flex;
            gap: var(--item-padding);
            flex-wrap: nowrap;
            justify-content: center;
            width: 100%;
        }

        /* Character Card Styling */
        .two-dialog-card {
            width: calc(50% - (var(--item-padding) / 2));
            height: 480px; /* Increased height */
            border-radius: 8px; /* Smoother radius */
            background: repeating-linear-gradient(
                45deg,
                var(--item-sprite-line),
                var(--item-sprite-line) 2px,
                transparent 2px,
                transparent 6px
            );
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            overflow: hidden;
            transition: width 0.5s ease-in-out, transform 0.3s ease;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .two-dialog-char-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center 20%; /* Adjust image focus */
            margin: 0;
            transition: filter 0.5s, transform 0.5s ease-in-out;
        }
        
        /* Card Hover Effect */
        .two-dialog-card:hover {
            width: 60%; /* Slightly larger hover effect */
            transform: scale(1.02);
            z-index: 10;
        }

        .two-dialog-card:hover > .two-dialog-char-img {
            filter: blur(5px) brightness(0.7);
            transform: scale(1.1);
        }

        /* Info Panel on Hover */
        .two-dialog-info {
            font-family: 'Gowun Batang', 'Roboto', sans-serif;
            position: absolute;
            z-index: 1;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            border-radius: 4px;
            padding: 15px;
            opacity: 0;
            transition: opacity 0.5s;
            max-height: 90%;
            overflow-y: auto;
            width: 90%;
            color: white;
            visibility: hidden; /* Hide by default */
        }

        .two-dialog-card:hover .two-dialog-info {
            opacity: 1;
            visibility: visible; /* Show on hover */
        }

        .two-dialog-info-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
            line-height: 1.5;
            display: flex;
            gap: 8px;
        }
        .two-dialog-info-box .label {
            font-weight: bold;
            color: #ddd;
            flex-shrink: 0;
        }
        .two-dialog-info-box .value {
            flex-grow: 1;
            color: #fff;
            outline: none;
            min-height: 1.2em;
        }
        .two-dialog-info-box .value:focus {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }


        .two-dialog-info-box:last-child {
            margin-bottom: 0;
        }
        
        /* Mood/Inner Thought Box */
        .cc-info-box1 {
            background: #9D90B4;
            color: #3F3551;
            font-family: 'Noto Serif KR', serif;
            font-weight: 900;
        }
        .cc-info-box1 .label {
            color: #5a4b73;
        }
        .cc-info-box1 .value {
            color: #3F3551;
        }


        /* Time/Weather Display Card */
        .two-dialog-simple-card {
            width: 100%;
            height: auto; /* 높이를 자동으로 조절하여 내용에 맞춤 */
            border-radius: 8px;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            overflow: hidden;
            position: relative;
            padding: 15px;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0, 0, 0, 0.3); /* 배경이 잘 보이도록 반투명 배경 추가 */
            backdrop-filter: blur(2px);
        }

        /* 요청사항 02: 기존의 작은 날씨 이미지는 제거되었으므로 관련 스타일도 제거합니다. */

        .two-dialog-details {
            color: white;
            text-align: right;
            font-family: 'Gowun Batang', 'Roboto', sans-serif;
            z-index: 1;
            position: relative;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px 15px;
            font-size: 1em;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            text-shadow: 1px 1px 3px #000;
        }
        .date { font-size: 0.9em; }
        .time { font-weight: bold; font-size: 1.2em;}

        /* Weather Controller */
        .weather-control {
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .weather-control label {
            color: white;
            font-family: 'Gowun Batang', sans-serif;
        }
        .weather-control button {
            background-color: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .weather-control button:hover {
            background-color: rgba(255,255,255,0.4);
        }
        .weather-control button.active {
            background-color: #9D90B4;
            color: #3F3551;
            font-weight: bold;
            border-color: #9D90B4;
        }
    </style>
</head>
<body>

    <div class="two-dialog-col">
        <!-- Weather Selection UI -->
        <div class="weather-control">
            <label>날씨 선택:</label>
            <button data-weather="Clear">맑음</button>
            <button data-weather="Cloudy">흐림</button>
            <button data-weather="Rainy">비</button>
            <button data-weather="Snowy">눈</button>
        </div>

        <div class="two-dialog-dialog">
            <div class="two-dialog-container">
                <!-- Bardock's Card -->
                <div id="bardock-card" class="two-dialog-card">
                    <!-- 요청사항 01: 이미지 경로를 로컬 파일로 수정합니다. -->
                    <img src="https://blog.kakaocdn.net/dna/bKu25Q/btsQb5EAB6M/AAAAAAAAAAAAAAAAAAAAANYNIyVG4rc7JTmmSVIW36iwP15HeLNwP_vjDGrdunOZ/img.jpg?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1756652399&allow_ip=&allow_referer=&signature=Jpk0%2FguItPmYKHMMbkLyljXvFRM%3D" alt="Bardock" class="two-dialog-char-img"/>
                    <div class="two-dialog-info">
                        <h3 style="text-align: center; margin-top: 0;">BARDOCK</h3>
                        <div class="two-dialog-info-box">
                            <span class="label">위치:</span>
                            <div class="value" id="bardock-location" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">옷차림:</span>
                            <div class="value" id="bardock-outfit" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">관계:</span>
                            <div class="value" id="bardock-relations" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">상태:</span>
                            <div class="value" id="bardock-status" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box cc-info-box1">
                            <span class="label">내심:</span>
                            <div class="value" id="bardock-thoughts" contenteditable="true"></div>
                        </div>
                    </div>
                </div>
                <!-- Toma's Card -->
                <div id="toma-card" class="two-dialog-card">
                     <!-- 요청사항 01: 이미지 경로를 로컬 파일로 수정합니다. -->
                    <img src="https://blog.kakaocdn.net/dna/bMS9On/btsQfjnzx4B/AAAAAAAAAAAAAAAAAAAAAGloEax36-NIMuZAMpBgzEbdxEfeo0sDNSR9NR2iS9e7/img.png?credential=yqXZFxpELC7KVnFOS48ylbz2pIh7yKj8&expires=1756652399&allow_ip=&allow_referer=&signature=upx9leFKDbUBAFv5IQ%2BONLRVoS4%3D" alt="Toma" class="two-dialog-char-img"/>
                    <div class="two-dialog-info">
                        <h3 style="text-align: center; margin-top: 0;">TOMA</h3>
                        <div class="two-dialog-info-box">
                            <span class="label">위치:</span>
                            <div class="value" id="toma-location" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">옷차림:</span>
                            <div class="value" id="toma-outfit" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                           <span class="label">관계:</span>
                            <div class="value" id="toma-relations" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box">
                            <span class="label">상태:</span>
                            <div class="value" id="toma-status" contenteditable="true"></div>
                        </div>
                        <div class="two-dialog-info-box cc-info-box1">
                            <span class="label">내심:</span>
                            <div class="value" id="toma-thoughts" contenteditable="true"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Time and Weather Display -->
            <div class="two-dialog-simple-card">
                <!-- 요청사항 02: 작은 날씨 배경 이미지를 제거했습니다. 이제 body 전체에 배경이 표시됩니다. -->
                <div class="two-dialog-details">
                    <div class="date" id="date-display"></div>
                    <div class="time" id="time-display"></div>
                </div>
            </div>
        </div>
    </div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// 1. Firebase 초기화: 아까 복사해 둔 firebaseConfig 코드를 여기에 붙여넣으세요!
const firebaseConfig = {
    apiKey: "AIzaSyD-X7U6_dYnHTGWCikMw1zpb78SlWXMqqI",
    authDomain: "project-8519339398731273721.firebaseapp.com",
    databaseURL: "https://project-8519339398731273721-default-rtdb.firebaseio.com/", // 중요: Realtime Database URL을 확인하세요!
    projectId: "project-8519339398731273721",
    storageBucket: "project-8519339398731273721.firebasestorage.app",
    messagingSenderId: "255930835214",
    appId: "1:255930835214:web:2482a3d96fd1928e3a775f"
};

// Firebase 앱 초기화
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTS ---
    const editableFields = document.querySelectorAll('.value[contenteditable="true"]');
    const weatherButtons = document.querySelectorAll('.weather-control button');
    const dateDisplay = document.getElementById('date-display');
    const timeDisplay = document.getElementById('time-display');

    // --- DATA ---
    const backgroundAssets = {
        Clear_morning: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FSEQyx%2FbtsQcmsxyMM%2FAAAAAAAAAAAAAAAAAAAAAL7FxjmcDQGEG5Rq38xgbAEycpXSofwQ22SIoNL0KDrI%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3D9Icurk8mHUK%252FJ1MGefECm64u9X0%253D',
        Clear_afternoon: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2Fn51FS%2FbtsQdnqZxQk%2FAAAAAAAAAAAAAAAAAAAAAMlaHg-609qTTfenJnzCPx9a_KPCjhQwNUE3t78wsjEV%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3DB9wxMhj9u%252BAen3o1mwVHBg4azpA%253D',
        Clear_evening: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FcUAlL3%2FbtsQdrNFI5Z%2FAAAAAAAAAAAAAAAAAAAAACEzBecgHYYy8PwwFc4iJ4TzWh9J-izW1IOWem3xgcJG%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3DC2O0kIT%252BNPv89iwUP6PDjS0cB%252BU%253D',
        Clear_night: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2F0vELJ%2FbtsQfiI1hC2%2FAAAAAAAAAAAAAAAAAAAAAKyi16A-89cMhJ7rx9_XcXcFJGWeGiAfjaG2epqPnwdX%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3Dh1fl6uOhVrEqv3itvRbHo%252BvB8VE%253D',
        Cloudy_morning: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FPD6ma%2FbtsQc6wfSBL%2FAAAAAAAAAAAAAAAAAAAAAKLRfoP04NpOe0eFCm1Wc0HEOGSLw7lGXqKxWiLc2QqW%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3DktgqTVZS3FYcvrdLCtqMw7dMgYo%253D',
        Cloudy_afternoon: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FBj5Zt%2FbtsQfgqSbh7%2FAAAAAAAAAAAAAAAAAAAAAOK994kPgRsvrM4IdJR9pQ36CfoLRofIX9mwk9KlUS-4%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3D3ucQaO6Rea8fvD1YmMNmzpgWN2A%253D',
        Cloudy_evening: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FWJUS7%2FbtsQc6Xgl8h%2FAAAAAAAAAAAAAAAAAAAAABFXTm8PX1ZnGkUAwn7Yhcexr4ba0DbgyycYiZjXTJYI%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3D6YSaafIrwcaO%252BOiR%252BjLy8J9x7B4%253D',
        Cloudy_night: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FbtOeiz%2FbtsQezjTim9%2FAAAAAAAAAAAAAAAAAAAAAPA7dLgQpkDM9FTfnoaOsnvTFUqpNxmBxyzxA2RvIP1E%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3Dkr17IOoWzVRALp02pOTejq8xkYM%253D',
        Rainy_day: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FeirrGO%2FbtsQe8l3mps%2FAAAAAAAAAAAAAAAAAAAAAAlRVPRGRhDEsjtVh-K3_HcJRanhbAq-TVytWEtp1WAi%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3D52xs8gPufNM8CCjsmSvNfacieFg%253D',
        Snowy_day: 'https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FbUw51u%2FbtsQe80CgOq%2FAAAAAAAAAAAAAAAAAAAAABj0aN3yNisO633yhgtPR92YczqoBjCOdM1gdoHUhcZ_%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3DhgDMAhLHulpswfMhJJAgq0C6lIo%253D',
    };

    let currentConfig = {
        weather: 'Clear', // 기본값
    };

    // --- FIREBASE FUNCTIONS (기존 localStorage 함수 대체) ---

    // 1. Firebase에서 데이터 불러오고, 실시간 변경 감지하기
    function syncDataFromFirebase() {
        // 'statusData'라는 이름으로 저장된 데이터를 감지합니다.
        database.ref('statusData').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // 캐릭터 정보 업데이트
                editableFields.forEach(field => {
                    if (data.characters && data.characters[field.id]) {
                        // Firebase에 저장된 값으로 화면을 업데이트합니다.
                        // 단, 현재 내가 수정 중인 필드는 강제로 덮어쓰지 않도록 체크합니다.
                        if (document.activeElement !== field) {
                           field.innerHTML = data.characters[field.id];
                        }
                    }
                });

                // 날씨 정보 업데이트
                if (data.weather) {
                    currentConfig.weather = data.weather;
                    updateWeatherButtons();
                    updateTimeAndBackground();
                }
            }
        });
    }

    // 2. Firebase에 데이터 저장하기
    function saveDataToFirebase(id, value) {
        // characters라는 그룹 아래에 각 필드 ID를 키로 하여 값을 저장합니다.
        database.ref(`statusData/characters/${id}`).set(value);
    }
    
    // 3. 날씨 선택 정보 Firebase에 저장하기
    function saveWeatherToFirebase(weatherValue) {
        database.ref('statusData/weather').set(weatherValue);
    }


    // --- ORIGINAL FUNCTIONS (일부 수정) ---
    
    // 3. Update weather button styles
    function updateWeatherButtons() {
        weatherButtons.forEach(button => {
            button.classList.toggle('active', button.dataset.weather === currentConfig.weather);
        });
    }

    // 4. Handle weather selection
    function handleWeatherChange(event) {
        const newWeather = event.target.dataset.weather;
        // Firebase에 새로운 날씨 값을 저장합니다. (이후 syncDataFromFirebase가 알아서 화면을 갱신합니다)
        saveWeatherToFirebase(newWeather);
    }

    // --- ACCURATE TIME LOGIC (변경 없음) ---
    let timeOffset = 0;
    async function syncTime() {
        try {
            const response = await fetch('https://timeapi.io/api/Time/current/zone?timeZone=Asia/Seoul');
            if (!response.ok) throw new Error('Network response was not ok.');
            const data = await response.json();
            const serverTime = new Date(data.dateTime).getTime();
            const localTime = new Date().getTime();
            timeOffset = serverTime - localTime;
        } catch (error) {
            console.error('온라인 시간 동기화 실패', error);
        }
    }

    // 5. 시간 및 배경 업데이트 함수 (변경 없음)
    function updateTimeAndBackground() {
        const correctedNow = new Date(new Date().getTime() + timeOffset);
        const optionsDate = { timeZone: 'Asia/Seoul', year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const optionsTime = { timeZone: 'Asia/Seoul', hour: '2-digit', minute: '2-digit', hour12: true };
        dateDisplay.textContent = new Intl.DateTimeFormat('ko-KR', optionsDate).format(correctedNow);
        timeDisplay.textContent = new Intl.DateTimeFormat('en-US', optionsTime).format(correctedNow);

        const kstHour = new Date(correctedNow.toLocaleString('en-US', { timeZone: 'Asia/Seoul' })).getHours();
        let timeOfDay;
        if (kstHour >= 6 && kstHour < 12) timeOfDay = 'morning';
        else if (kstHour >= 12 && kstHour < 18) timeOfDay = 'afternoon';
        else if (kstHour >= 18 && kstHour < 22) timeOfDay = 'evening';
        else timeOfDay = 'night';

        let bgKey = (currentConfig.weather === 'Rainy' || currentConfig.weather === 'Snowy')
            ? `${currentConfig.weather}_day`
            : `${currentConfig.weather}_${timeOfDay}`;
        
        const newBgAsset = backgroundAssets[bgKey] || backgroundAssets['Clear_morning'];
        const newBgUrl = `url('${newBgAsset}')`;
        if (document.body.style.backgroundImage !== newBgUrl) {
            document.body.style.backgroundImage = newBgUrl;
        }
    }
    
    // --- EVENT LISTENERS ---
    editableFields.forEach(field => {
        // 'input' 이벤트가 발생할 때마다 Firebase에 데이터를 저장합니다.
        field.addEventListener('input', (event) => {
            saveDataToFirebase(event.target.id, event.target.innerHTML);
        });
    });

    weatherButtons.forEach(button => {
        button.addEventListener('click', handleWeatherChange);
    });

    // --- INITIALIZATION ---
    // Firebase와 데이터 동기화를 시작합니다.
    syncDataFromFirebase();
    
    syncTime().then(() => {
        updateTimeAndBackground(); 
        setInterval(updateTimeAndBackground, 1000); 
    });
    setInterval(syncTime, 600000);
});
</script>

</body>
</html>

